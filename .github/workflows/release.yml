name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.get_version.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [[ "$VERSION" == *-* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Comine v${{ steps.get_version.outputs.version }}
          draft: true
          prerelease: ${{ steps.get_version.outputs.is_prerelease == 'true' }}
          generate_release_notes: true

  build-linux:
    needs: create-release
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        run: |
          pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Verify signatures were generated
        run: |
          echo "Looking for signature files..."
          find src-tauri/target/release/bundle -name "*.sig" -type f
          if [ $(find src-tauri/target/release/bundle -name "*.sig" -type f | wc -l) -eq 0 ]; then
            echo "ERROR: No .sig files found! Signing may have failed."
            exit 1
          fi

      - name: List generated files
        run: |
          echo "=== AppImage bundle files ==="
          ls -la src-tauri/target/release/bundle/appimage/ || true
          echo "=== Updater bundle files ==="
          ls -la src-tauri/target/release/bundle/appimage-updater/ || true

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage-updater/*.AppImage.tar.gz
            src-tauri/target/release/bundle/appimage-updater/*.AppImage.tar.gz.sig

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app (pre-release - NSIS only)
        if: needs.create-release.outputs.is_prerelease == 'true'
        shell: pwsh
        run: |
          pnpm tauri build --bundles nsis
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build Tauri app (stable - all bundles)
        if: needs.create-release.outputs.is_prerelease != 'true'
        shell: pwsh
        run: |
          pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Verify signatures were generated
        shell: pwsh
        run: |
          $sigFiles = Get-ChildItem -Path "src-tauri/target/release/bundle" -Recurse -Filter "*.sig"
          if ($sigFiles.Count -eq 0) {
            Write-Error "No .sig files found! Signing may have failed."
            exit 1
          }
          Write-Host "Found signature files:"
          $sigFiles | ForEach-Object { Write-Host $_.FullName }

      - name: Create portable exe
        shell: pwsh
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          $exePath = "src-tauri/target/release/comine.exe"
          if (Test-Path $exePath) {
            Copy-Item $exePath "src-tauri/target/release/comine_${version}_x64-portable.exe"
          }

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          fail_on_unmatched_files: false
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.sig
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig
            src-tauri/target/release/comine_*_x64-portable.exe

  build-macos:
    needs: create-release
    runs-on: macos-latest
    strategy:
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        run: |
          pnpm tauri build --target ${{ matrix.target }}
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Verify signatures were generated
        run: |
          echo "Looking for signature files..."
          find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.sig" -type f
          if [ $(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.sig" -type f | wc -l) -eq 0 ]; then
            echo "ERROR: No .sig files found! Signing may have failed."
            exit 1
          fi

      - name: Rename macOS artifacts
        run: |
          cd src-tauri/target/${{ matrix.target }}/release/bundle/macos
          if [ "${{ matrix.target }}" = "x86_64-apple-darwin" ]; then
            for f in *.app.tar.gz; do mv "$f" "${f%.app.tar.gz}_x64.app.tar.gz"; done
            for f in *.app.tar.gz.sig; do mv "$f" "${f%.app.tar.gz.sig}_x64.app.tar.gz.sig" 2>/dev/null || true; done
          fi

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig

  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: aarch64
            rust_target: aarch64-linux-android
            artifact_name: arm64-v8a
          - target: armv7
            rust_target: armv7-linux-androideabi
            artifact_name: armeabi-v7a
          - target: x86_64
            rust_target: x86_64-linux-android
            artifact_name: x86_64
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;27.0.11718014"
          echo "NDK_HOME=$ANDROID_HOME/ndk/27.0.11718014" >> $GITHUB_ENV

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.5" --locked

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: android-${{ matrix.target }}

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > src-tauri/gen/android/app/release.keystore

      - name: Create keystore properties
        run: |
          cat > src-tauri/gen/android/app/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build Android APK
        run: |
          cd src-tauri
          cargo tauri android build --target ${{ matrix.target }}

      - name: Rename APK
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          mkdir -p release-assets
          find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -exec cp {} release-assets/comine-${VERSION}-${{ matrix.artifact_name }}.apk \;

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: release-assets/*.apk

  build-android-universal:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;27.0.11718014"
          echo "NDK_HOME=$ANDROID_HOME/ndk/27.0.11718014" >> $GITHUB_ENV

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.5" --locked

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: android-universal

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > src-tauri/gen/android/app/release.keystore

      - name: Create keystore properties
        run: |
          cat > src-tauri/gen/android/app/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build Universal Android APK
        run: |
          cd src-tauri
          cargo tauri android build --apk true

      - name: Rename Universal APK
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          mkdir -p release-assets
          # Find the release APK (fat APK with all ABIs)
          APK=$(find src-tauri/gen/android/app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          if [ -n "$APK" ]; then
            cp "$APK" "release-assets/comine-${VERSION}-universal.apk"
          else
            # Fallback: find any APK
            APK=$(find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -type f | head -1)
            cp "$APK" "release-assets/comine-${VERSION}-universal.apk"
          fi
          ls -la release-assets/

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: release-assets/*.apk

  generate-update-manifest:
    needs: [create-release, build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download signatures from draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          RELEASE_ID=${{ needs.create-release.outputs.release_id }}

          echo "Fetching assets from release ID: $RELEASE_ID"

          # Wait for all uploads to complete
          sleep 30

          # Get release assets
          ASSETS=$(curl -sL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/nichind/comine/releases/$RELEASE_ID/assets")

          echo "Found assets:"
          echo "$ASSETS" | jq -r '.[].name'

          download_asset() {
            local asset_name=$1
            local output_file=$2
            
            # Get asset download URL
            ASSET_URL=$(echo "$ASSETS" | jq -r ".[] | select(.name == \"$asset_name\") | .url")
            
            if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
              echo "Asset $asset_name not found, waiting..."
              return 1
            fi
            
            # Download the asset (need to follow redirects with proper auth)
            curl -sL \
              -H "Accept: application/octet-stream" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              "$ASSET_URL" -o "$output_file"
            
            if [ -s "$output_file" ]; then
              echo "Downloaded $asset_name"
              return 0
            else
              echo "Failed to download $asset_name"
              return 1
            fi
          }

          # Retry logic for each signature
          for attempt in {1..10}; do
            echo ""
            echo "=== Attempt $attempt/10 ==="
            
            # Refresh assets list
            ASSETS=$(curl -sL \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/nichind/comine/releases/$RELEASE_ID/assets")
            
            ALL_FOUND=true
            
            download_asset "comine_${VERSION}_amd64.AppImage.tar.gz.sig" "linux.sig" || ALL_FOUND=false
            download_asset "comine_${VERSION}_x64-setup.exe.sig" "windows.sig" || ALL_FOUND=false
            download_asset "comine.app.tar.gz.sig" "darwin-arm.sig" || ALL_FOUND=false
            download_asset "comine_x64.app.tar.gz.sig" "darwin-x64.sig" || ALL_FOUND=false
            
            if [ "$ALL_FOUND" = true ]; then
              echo ""
              echo "All signatures downloaded successfully!"
              break
            fi
            
            echo "Some signatures missing, waiting 30 seconds..."
            sleep 30
          done

          echo ""
          echo "Downloaded signature files:"
          ls -la *.sig 2>/dev/null || echo "No .sig files found!"

      - name: Generate latest.json
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          REPO="https://github.com/nichind/comine/releases/download/v${VERSION}"

          # Read signatures
          LINUX_SIG=""
          WINDOWS_SIG=""
          DARWIN_ARM_SIG=""
          DARWIN_X64_SIG=""

          [ -f linux.sig ] && LINUX_SIG=$(cat linux.sig)
          [ -f windows.sig ] && WINDOWS_SIG=$(cat windows.sig)
          [ -f darwin-arm.sig ] && DARWIN_ARM_SIG=$(cat darwin-arm.sig)
          [ -f darwin-x64.sig ] && DARWIN_X64_SIG=$(cat darwin-x64.sig)

          # Generate JSON with jq to properly escape signatures
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See release notes at https://github.com/nichind/comine/releases/tag/v${VERSION}" \
            --arg pub_date "$DATE" \
            --arg linux_url "${REPO}/comine_${VERSION}_amd64.AppImage.tar.gz" \
            --arg linux_sig "$LINUX_SIG" \
            --arg windows_url "${REPO}/comine_${VERSION}_x64-setup.exe" \
            --arg windows_sig "$WINDOWS_SIG" \
            --arg darwin_arm_url "${REPO}/comine.app.tar.gz" \
            --arg darwin_arm_sig "$DARWIN_ARM_SIG" \
            --arg darwin_x64_url "${REPO}/comine_x64.app.tar.gz" \
            --arg darwin_x64_sig "$DARWIN_X64_SIG" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "linux-x86_64": { signature: $linux_sig, url: $linux_url },
                "windows-x86_64": { signature: $windows_sig, url: $windows_url },
                "darwin-aarch64": { signature: $darwin_arm_sig, url: $darwin_arm_url },
                "darwin-x86_64": { signature: $darwin_x64_sig, url: $darwin_x64_url }
              }
            }' > latest.json

          echo "Generated latest.json:"
          cat latest.json

          # Verify signatures are present
          echo ""
          EMPTY_SIGS=$(jq -r '.platforms | to_entries[] | select(.value.signature == "") | .key' latest.json)
          if [ -n "$EMPTY_SIGS" ]; then
            echo "The following platforms have empty signatures:"
            echo "$EMPTY_SIGS"
          else
            echo "All platforms have valid signatures!"
          fi

      - name: Upload manifest to release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: latest.json

  publish-release:
    needs:
      [
        create-release,
        build-linux,
        build-windows,
        build-macos,
        build-android,
        build-android-universal,
        generate-update-manifest,
      ]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            });
